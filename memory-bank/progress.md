# 進捗状況：YouTube データ分析可視化サービス

## 完了済みの項目

### 1. 要件分析フェーズ

- ✅ 設計書の確認と要件整理
- ✅ データベース仕様の把握
- ✅ ワイヤーフレームの分析と理解
- ✅ Supabase 接続情報の確認

### 2. 設計フェーズ

- ✅ 全体アーキテクチャの設計
- ✅ 画面構成の決定（ホーム、動画一覧、動画分析の 3 画面）
- ✅ ファイル構成・ディレクトリ構造の設計
- ✅ データフロー設計
- ✅ RPC 関数の設計
- ✅ メモリバンクファイルの作成・ドキュメント化

## 進行中の項目

### 1. 開発環境構築

- ✅ プロジェクト初期構造の作成
- ✅ 必要ライブラリのリスト化と依存関係の整理
- 🔄 .streamlit/config.toml の設定

### 2. Supabase 連携

- ✅ Supabase クライアント設定実装 (バージョン 1.0.3 に修正)
- ✅ 基本データアクセス関数の実装 (エラーハンドリング強化済)
- 🔄 RPC 関数の作成と動作確認
  - 現在エラー発生中: metrics_agg、multi_term_comment_hist、search_comments_multi などの関数が見つからない
  - エラーメッセージ: `'Could not find the function public.metrics_agg(_g, _vid) in the schema cache'`
  - 動画詳細情報の取得エラー: `'JSON object requested, multiple (or no) rows returned'`
  - クライアントサイド実装の未定義エラー: `name 'client_side_metrics_agg' is not defined`
  - データベーススキーマと実データの確認が必要

### 3. エラー処理の実装

- ✅ Supabase クライアントライブラリのバージョン対応
- ✅ データ取得関数のエラーハンドリング強化
- ✅ 日付フォーマット処理の null チェック追加
- ✅ グラフ描画関数の例外処理追加

### 4. UI 機能の実装状況

- ✅ Home.py（チャンネル一覧画面）の基本実装
- ✅ 01_Videos.py（動画一覧画面）の基本実装
- ✅ 02_Analysis.py（動画分析画面）の基本構造実装
- 🔄 YouTube プレイヤーとグラフ連携機能のデバッグ
- 🔄 コントロールパネルのデザイン実装
- 🔄 タブ間の状態管理改善
- 🔄 感情分析タブのグラフから表形式表示への変更

### 5. YouTube プレイヤー連携の改善（2025/5/4 更新）

- ✅ YouTube プレイヤーと他のコンポーネント間の通信問題の根本原因を特定
  - Streamlit の`st.components.v1.html()`の独立した iframe による分離問題
  - Same-Origin ポリシーによるフレーム間通信の制限
- ✅ 解決策の実装完了
  - YouTube プレイヤー下部に直接シークボタンを統合
  - Python セッション状態を活用した間接通信方式を実装
  - `_seek_sec`変数を導入してフレーム間通信回避
  - 互換性のため従来の`sec`変数も維持
- ✅ チャプターセクションボタンの機能改善完了
  - ボタンクリック時に Python セッション変数を設定
  - プレイヤー初期化時にシーク命令を実行
  - すべてのチャプタージャンプボタンが動作可能に
- ✅ グラフクリック時の無限リロード問題を修正（2025/5/4）
  - クリーンアップブロックの実行順序を修正
  - クリーンアップを YouTube プレイヤー初期化後に移動
  - 各グラフタイプごとに連続クリック検出・防止ロジックを実装
    - メトリクスグラフ：`last_clicked_sec`
    - 検索グラフ：`last_clicked_sec_search`
    - 感情分析グラフ：`last_clicked_sec_emotion`
  - デバッグログを追加して連続クリック検出を表示

## これから取り組む項目

### 1. Streamlit UI バグ修正

- ⬜ ウィジェット重複エラー (`streamlit.errors.DuplicateWidgetID`) の解決
  - 複数のスライダーでの一意のキー設定
  - サイドバーとコントロールパネルのコンポーネント整理

### 2. YouTube プレイヤー連携バグ修正

- 🔄 グラフクリックによる動画シーク機能の修正
  - メトリクスグラフと YouTube プレイヤーの連携強化
  - 同一 iframe 内アプローチの検討
  - メッセージング方式の改善
  - タブボタンと同様の Python セッション状態アプローチの適用検討
- ⬜ YouTube プレイヤー API との連携強化
  - 準備状態検出の信頼性向上
  - エラーハンドリングの強化

### 3. チャプタータブ UI の改善

- 🔄 ボタン形式 UI の実装（試験段階）
  - 表形式からボタン形式への変更
  - Plotly グラフとの連携方法の確立
  - ユーザー体験の向上検証

### 4. データベース連携の修正

- ⬜ Supabase RPC 関数の作成あるいは修正
  - `metrics_agg`、`multi_term_comment_hist`、`search_comments_multi` 関数の実装
- ⬜ テスト用サンプルデータの準備と実装
- ⬜ クライアントサイド実装の適切な定義と利用
- ⬜ エラー状態でも適切な UI を表示するフォールバック機能の強化

### 5. メトリクスグラフとデータ可視化の改善

- ⬜ 音量データの可視化の改善
- ⬜ コメント頻度の可視化の品質向上
- ⬜ グラフクリックによるシーク機能の安定化
- ⬜ データなし時のダミーデータ生成機能の最適化 → ダミーデータを生成しても分析の意味が全くないため、データなし時の挙動を検討する必要あり。

### 6. 各タブの実装

- 🔄 チャプタータブの新 UI 実装（ボタン形式に変更）
- ⬜ コメントタブの実装
- ⬜ 文字起こしタブの実装
- ⬜ 感情分析タブの実装

### 7. 最適化とテスト

- ⬜ キャッシュ戦略の最適化
- ⬜ パフォーマンステスト
- ⬜ 複数検索ワード対応のテスト
- ⬜ レスポンシブデザイン対応

### 8. デプロイ準備

- ⬜ Streamlit Cloud へのデプロイ設定
- ⬜ 環境変数の設定
- ⬜ 最終テストと確認

## 既知の課題

### 1. 技術的な課題

- 🔄 YouTube プレイヤーと Streamlit 間の通信方法
  - 同一 iframe 内にプレイヤーとコントロールを配置するアプローチの拡張
  - postMessage API の活用と制限の理解
  - グローバル関数によるシーク命令の伝達改善
- 大量コメントデータ処理時のパフォーマンス（サーバーサイド集計で対応予定）
- 複数検索ワード一致の実装方法
- **解決に取り組み中:** グラフクリックイベントから YouTube プレイヤーへのシーク動作が機能していない
  - YouTube プレイヤーが返す値が予期しない型（DeltaGenerator）になっている問題を特定
  - iframe の検出方法の改善が必要
  - 統合 iframe アプローチまたはメッセージング強化の検討
- **部分的に解決:** タブ内のジャンプボタンが正しく動作していない問題
  - YouTube プレイヤー下部にチャプターシークボタンを統合して部分的に回避
  - チャプタータブ UI の改良でさらなる改善を検討中

### 2. UX 課題

- 動画再生とグラフ同期の遅延対策
- モバイル表示での画面レイアウト最適化
- 大量データ表示時の応答性確保
- グラフの視覚的な表現の改善（より直感的なデータ可視化）
- エラー状態での適切なフォールバック UI とユーザーへのフィードバック
- **新たな方向性:** 情報とボタンを統合した大きめのボタン形式 UI
  - 情報の視認性と操作性を両立
  - 直感的なユーザー体験の提供
  - チャプタータブから試験導入し、効果検証後に他タブへの展開を検討
- 感情分析グラフで出力されていないカラムがある問題 - 取得カラムの再確認が必要

### 3. データベース連携の課題

- **解決済み:** Supabase RPC 関数が見つからない問題 - 3 つの RPC 関数を新規作成:
  - metrics_agg: メトリクス集計
  - multi_term_comment_hist: コメント頻度の複数検索語対応
  - search_comments_multi: 複数検索語によるコメント検索
- **解決済み:** クライアントサイド実装の未定義エラー - 循環インポートを解消
- **解決に取り組み中:** 動画詳細情報の取得時エラー:
  - 取得メソッドを`.single()`から`.limit(1)`に変更し、結果をより堅牢に処理
  - 内部 ID（数値）での検索フォールバックを追加
- **重要:** データベース内のデータ有無、取得するテーブルやカラムの適正化を優先的に確認する必要あり
  - ダミーデータの生成よりも、まずデータが存在するかの確認が必要
  - テーブル構造とカラム名の再確認が必要

### 4. デプロイ課題

- Streamlit Cloud での環境変数管理
- シークレット情報（Supabase API Key）の安全な管理

## 今後の方向性

1. **段階的な機能実装アプローチ**

   - 基本画面構造を最初に実装し、動作確認
   - 各タブの機能を順次追加
   - 最適化は最後に集中的に実施

2. **ユーザーテストとフィードバックの計画**

   - 基本機能実装後にユーザーテストを実施
   - UI/UX の改善点を特定

3. **新 UI 設計の導入計画**
   - チャプタータブからボタン形式 UI を試験導入
   - 効果検証後に他のタブへ展開
   - ユーザー体験の向上と技術的制限の解消を両立

## マイルストーン計画

| マイルストーン | 内容                         | 予定   |
| -------------- | ---------------------------- | ------ |
| **M1**         | 開発環境構築と Supabase 連携 | 3 日間 |
| **M2**         | 基本画面構造実装             | 4 日間 |
| **M3**         | 動画分析画面の基本機能実装   | 5 日間 |
| **M4**         | 各タブ機能の詳細実装         | 7 日間 |
| **M5**         | 最適化とテスト               | 3 日間 |
| **M6**         | デプロイと最終確認           | 3 日間 |
