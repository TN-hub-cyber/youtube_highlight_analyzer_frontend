# アクティブコンテキスト：YouTube データ分析可視化サービス

## 現在の開発フォーカス

現在、YouTube 動画分析可視化サービスの開発計画策定段階にあります。設計書とデータベース仕様書を元に、Streamlit フロントエンドと Supabase RPC の開発計画を立てています。

### 最新の進捗状況

1. **プロジェクト要件の把握**

   - 設計書の内容確認完了
   - データベース仕様の確認完了
   - ワイヤーフレームの確認完了

2. **開発計画の策定**

   - アプリケーション構成の設計完了
   - 開発ファイル構成の設計完了
   - 実装スケジュールの策定完了

3. **実装準備**
   - Supabase 接続情報の確認完了
   - 技術スタックの決定完了
   - Memory-bank ファイル群の作成中

## 最近の重要な変更

1. **設計方針の決定**

   - Streamlit のマルチページアプリ構造の採用
   - YouTube プレイヤーとグラフの双方向連携方式の決定
   - Supabase RPC 関数の設計方針確定

2. **UI デザイン方針**

   - ワイヤーフレームに基づく UI 構造の決定
   - 各画面の主要コンポーネント構成の確認
   - 操作フローの最適化決定

3. **データフロー設計**
   - Supabase からのデータ取得パターン決定
   - キャッシュ戦略の策定
   - 複数検索ワード対応の設計完了

## 進行中のタスク

1. **Memory-bank ファイルの作成**

   - プロジェクトの重要情報を文書化
   - 技術コンテキストの整理
   - システムアーキテクチャの文書化

2. **開発環境の準備**

   - プロジェクト構造の設計
   - 必要ライブラリの特定
   - RPC 関数の実装準備

3. **実装計画の詳細化**
   - 機能実装の優先順位付け
   - テスト戦略の策定
   - デプロイ計画の策定

## 直近の決定事項

1. **画面構造**

   - ホーム画面（チャンネル一覧）→ 動画一覧画面 → 動画分析画面の 3 画面構成
   - 動画分析画面は 4 つのタブ（チャプター、コメント、文字起こし、感情分析）で構成

2. **データ連携**

   - Supabase RPC を活用した効率的なデータ取得・集計
   - 複数検索ワードに対応した柔軟なコメント検索機能
   - サーバーサイドでの集計処理によるクライアント負荷軽減

3. **インタラクション設計**
   - グラフクリックによる動画シーク機能
   - 動画再生に合わせたグラフ上の現在位置マーカー更新
   - タブごとの専用コンテンツ表示と共通メトリクスグラフの維持

## 次のステップ

1. **開発環境設定**

   - Streamlit プロジェクトの初期構造作成
   - 必要なライブラリのインストール
   - Supabase 接続設定の実装

2. **基本画面構造の実装**

   - Home.py（チャンネル一覧画面）の実装
   - 01_Videos.py（動画一覧画面）の実装
   - 02_Analysis.py（動画分析画面）のベース実装

3. **Supabase RPC 関数の開発**
   - metrics_agg 関数の実装
   - multi_term_comment_hist 関数の実装
   - search_comments_multi 関数の実装

## 現在の課題

1. **データ量と処理速度の最適化**

   - 大量のコメントデータ処理時のパフォーマンス確保
   - 適切な粒度設定によるデータ量調整
   - キャッシュ戦略の最適化

2. **YouTube プレイヤー連携の実装**

   - IFrame と Streamlit の間での通信実装
   - ブラウザセキュリティ制限への対応
   - 再生状態の同期精度向上

3. **複数検索ワード対応の実装**

   - 効率的な検索アルゴリズムの選定
   - 結果の視覚的な表現方法
   - 大量検索結果のパフォーマンス最適化

## 発見されたバグと改善点（2025/5/4 更新）

1. **データベース接続と RPC 関数に関する問題**

   - 動画詳細情報の取得エラー：`{'code': 'PGRST116', 'details': 'The result contains 0 rows', 'hint': None, 'message': 'JSON object requested, multiple (or no) rows returned'}`
   - RPC 関数が見つからないエラー：`'Could not find the function public.metrics_agg(_g, _vid) in the schema cache'`
   - クライアントサイド実装の未定義エラー：`name 'client_side_metrics_agg' is not defined`
   - 循環インポートの問題：`utils/supabase_client.py`と`utils/data_utils.py`間の相互参照によるエラー
   - データベース内のデータ有無、取得するテーブルやカラムの適正化を優先的に確認する必要あり

2. **Streamlit のウィジェット重複エラー**

   - 複数の同一`st.slider`ウィジェットがあり、重複キーによるエラー発生
   - `streamlit.errors.DuplicateWidgetID`エラーの解決が必要
   - サイドバーとコントロールパネルの両方にスライダーが存在する問題

3. **動画プレイヤー連携の不具合**

   - **未解決:** グラフをクリックしても対象位置に動画がジャンプしない問題
   - ✅ タブ内のジャンプボタン（▶️）を押しても動画がジャンプしない問題が解決
   - YouTube プレイヤーとのインタラクションメカニズムの実装が改善された
   - YouTube プレイヤーが返す値の型問題も解決
   - グラフクリック時のシーク機能にも同様の Python セッション状態アプローチを適用することを検討中

4. **UI/UX の改善**
   - グラフの表現の視覚的な改善
   - ユーザビリティの向上（特に操作性と情報の見やすさ）
   - レスポンシブ性とモバイル対応の検討
   - 感情分析をグラフから表形式表示に変更
   - 感情分析グラフで出力されていないカラムがある問題 - 取得カラムの再確認が必要

## iframe 間通信問題の解決（2025/5/4 追加）

### 問題の詳細分析

1. **Same-Origin ポリシーによるフレーム間通信の制限**

   - Streamlit の各コンポーネント（YouTube プレイヤー、タブ内ボタン）が別々の iframe に分離されている
   - これらの iframe 間で JavaScript による直接通信ができない
   - postMessage の試みも受信側の設定が不十分で失敗

2. **フレーム構造の複雑さ**

   - YouTube プレイヤー iframe（src は`youtube.com/embed/...`）
   - Streamlit の st.components.v1.html()が作る iframe（src は`about:srcdoc`）
   - これらの異なるオリジンを持つ iframe 間での通信制限

3. **エラーメッセージ分析**
   - 「Uncaught (in promise) Error: Could not establish connection. Receiving end does not exist.」
   - メッセージの送信先が存在しない、またはメッセージを受け取れる状態になっていない

### 実装した解決策

1. **Python のセッション状態を活用した間接通信**

   - `_seek_sec`という新しいセッション変数を導入
   - ボタンクリック時に Python のセッション変数にシーク時間を保存
   - アプリ再読み込み時に YouTube プレイヤーがセッション変数を読み取りシーク

2. **コンポーネント改修**

   - `youtube_player.py`の JavaScript コード内で`seek_target`変数を確認するロジック追加
   - プレイヤー初期化完了時にシーク命令を実行
   - 冗長性確保のためのメッセージングも維持

3. **コードの構造改善**
   - シーク関数`seek_to()`を修正して新しい変数を使用
   - 互換性のため従来の`sec`変数も維持
   - プレイヤーコンポーネント呼び出し後にセッション変数をクリア

### 解決策のメリット

1. **ブラウザの Same-Origin ポリシーを回避**

   - JavaScript のフレーム間通信に依存せず
   - Python バックエンドのセッション状態を介して通信
   - ブラウザのセキュリティモデルに左右されない安定した実装

2. **シンプルな実装**

   - 複雑な JavaScript メッセージング処理が不要
   - ボタンは Python の変数を設定するだけの単純な機能
   - 処理の流れが明確で保守しやすい

3. **拡張性**
   - 他のタブ（コメント、文字起こし、感情分析）にも同じパターンを適用可能
   - 異なるコンポーネント間でも同様のアプローチが使用可能

## UI/UX 改善計画（2025/5/3 追加）

### Streamlit の IFrame 制限への対応

1. **問題の特定**

   - Streamlit の各`st.components.v1.html()`呼び出しが独立したサンドボックス iframe を生成
   - YouTube プレイヤー iframe とタブ内のボタンが別々のコンテキストとなり、通信できない
   - この分離がシーク機能（ジャンプボタン）の動作を妨げる根本原因

2. **実装された解決策**

   - YouTube プレイヤー下部に直接チャプターのシークボタンを統合
   - 同一 iframe 内にプレイヤーとコントロールを配置し、フレーム間の境界を回避
   - グローバル関数によるシーク命令の伝達機能の強化

3. **今後の改善方向性**
   - チャプタータブ UI の再設計：情報とボタンを統合したデザインへ
   - 大きめのボタンに情報を詰め込んだ直感的なインターフェースへの移行を検討
   - チャプタータブから開始し、効果が確認できれば他のタブ（コメント、文字起こし）にも同様の設計を適用検討

### 新しい UI 設計の方向性

1. **タブ表示の改良案**

   - 従来の表形式からボタン形式への変更
   - 各ボタン内に時間、タイトル、説明などの情報を包含
   - ボタン全体をクリック可能エリアとし、操作性を向上

2. **期待される効果**

   - より直感的なユーザー体験（ボタン＝アクション）
   - Streamlit の iframe 制限を回避した確実な動作
   - コンテンツと操作部分の統合による分かりやすさ

3. **段階的実装アプローチ**
   - まずはチャプタータブのみでボタン形式 UI を試験実装
   - 効果を検証した上で他のタブへ展開を検討
   - 追加機能（検索フィルタリングなど）の段階的追加
